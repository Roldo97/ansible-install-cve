---
- name: Check if CVEs are available (individually)
  register: cve_status
  changed_when: false
  failed_when: cve_status.rc != 0 and cve_status.rc != 100
  ansible.builtin.shell: "{{ ansible_facts['pkg_mgr'] }} check-update --cve {{ item }}"

- name: Add CVE to report
  when: cve_status.rc == 100
  delegate_to: localhost
  block:
    - ansible.builtin.lineinfile:
        path: "files/{{ tarea_sga }}-report-{{ current_date }}.csv"
        line: "{{ ansible_facts['fqdn'] }},{{ item }},Important,{{ current_date }}"
      when: item in important
    - ansible.builtin.lineinfile:
        path: "files/{{ tarea_sga }}-report-{{ current_date }}.csv"
        line: "{{ ansible_facts['fqdn'] }},{{ item }},Low,{{ current_date }}"
      when: item in low
    - ansible.builtin.lineinfile:
        path: "files/{{ tarea_sga }}-report-{{ current_date }}.csv"
        line: "{{ ansible_facts['fqdn'] }},{{ item }},Moderate,{{ current_date }}"
      when: item in moderate
    - ansible.builtin.lineinfile:
        path: "files/{{ tarea_sga }}-report-{{ current_date }}.csv"
        line: "{{ ansible_facts['fqdn'] }},{{ item }},Critical,{{ current_date }}"
      when: item in critical

